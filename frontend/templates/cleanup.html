{% extends "base.html" %}

{% block title %}Cleanup{% endblock %}
{% block header %}Cleanup & Reorganise{% endblock %}

{% block content %}
<div class="card">
    <h3>Manual Cleanup</h3>
    <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
        Use this tool to reorganize files already in your library. It uses your current settings as defaults.
    </p>

    <div id="cleanupForm">
        {% if config %}
        <label for="origin">Watch Folder (Scan for cleanup):</label><br>
        <div class="input-group">
            <input type="text" id="origin" name="origin" value="{{ config['INPUT_DIR'] }}"
                placeholder="/media/downloads">
            <button type="button" class="btn btn-secondary" onclick="browseFolder('origin')">Browse...</button>
        </div>

        <h4 style="margin-top: 25px;">Destination Folders</h4>

        <label for="malayalam_dest">Malayalam Movies Destination:</label><br>
        <div class="input-group">
            <input type="text" id="malayalam_dest" name="malayalam_dest" value="{{ config['MALAYALAM_DIR'] }}"
                placeholder="/media/movies/malayalam">
            <button type="button" class="btn btn-secondary" onclick="browseFolder('malayalam_dest')">Browse...</button>
        </div>

        <label for="english_dest">English Movies Destination (Default):</label><br>
        <div class="input-group">
            <input type="text" id="english_dest" name="english_dest" value="{{ config['MOVIES_DIR'] }}"
                placeholder="/media/movies">
            <button type="button" class="btn btn-secondary" onclick="browseFolder('english_dest')">Browse...</button>
        </div>

        <div
            style="margin-top: 20px; padding: 15px; background: #fffde7; border-left: 4px solid #fbc02d; border-radius: 4px;">
            <input type="checkbox" id="dry_run" name="dry_run" checked>
            <label for="dry_run" style="font-weight: bold; cursor: pointer;">Dry Run (Log only - Recommended
                first)</label>
            <p style="margin: 5px 0 0 25px; font-size: 13px; color: #555;">No files will be moved. View potential
                changes in the Cleanup Logs on the Dashboard.</p>
        </div>
        {% else %}
        <p style="color: red;">Error: System configuration could not be loaded. Please check your settings.</p>
        {% endif %}

        <div style="margin-top: 30px; display: flex; gap: 15px;">
            <button type="button" class="btn btn-primary" onclick="startCleanup()" id="startBtn"
                style="padding: 12px 30px;">Start Reorganisation</button>
            <button type="button" class="btn btn-danger" onclick="stopCleanup()" id="stopBtn"
                style="padding: 12px 30px; display: none !important;">Stop Operation</button>
        </div>
    </div>

    <div id="status" style="margin-top: 25px; padding: 20px; border-radius: 8px; display: none; line-height: 1.6;">
    </div>
</div>

<div class="card">
    <h3>üìú Cleanup Activity Log</h3>
    <p style="color:#666; font-size:13px;">Shows language detected and destination from cleanup/organise activity.</p>
    <div id="cleanupActivityFeed" style="max-height:320px; overflow-y:auto; font-size:13px;">
        <p style="color:#666;">Loading cleanup activity...</p>
    </div>
</div>

<style>
    .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .input-group input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
</style>

{% endblock %}

{% block scripts %}
<script src="/static/folder-browser.js"></script>
<script>
    let pollInterval = null;

    window.onload = function () {
        checkStatus();
        loadCleanupActivity();
        pollInterval = setInterval(() => { checkStatus(); loadCleanupActivity(); }, 3000);
    };

    async function checkStatus() {
        try {
            const response = await fetch('/api/cleanup/status');
            const data = await response.json();

            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const statusDiv = document.getElementById('status');

            if (data.is_running) {
                startBtn.disabled = true;
                startBtn.style.opacity = '0.5';
                stopBtn.style.display = 'inline-block';

                if (data.should_stop) {
                    stopBtn.disabled = true;
                    stopBtn.innerText = 'Stopping...';
                    stopBtn.style.opacity = '0.5';
                } else {
                    stopBtn.disabled = false;
                    stopBtn.innerText = 'Stop Operation';
                    stopBtn.style.opacity = '1';
                }

                statusDiv.style.display = 'block';
                statusDiv.style.background = '#e3f2fd';
                statusDiv.style.color = '#0d47a1';
                statusDiv.style.border = '1px solid #bbdefb';
                statusDiv.innerHTML = `‚è≥ <strong>Cleanup in progress...</strong><br>Currently processing: <code style="word-break: break-all;">${data.current_file || 'Starting...'}</code>`;
            } else {
                startBtn.disabled = false;
                startBtn.style.opacity = '1';
                stopBtn.style.display = 'none';

                // If it was just running, we might want to clear status but usually the logs handle this
            }
        } catch (e) {
            console.error('Failed to fetch status:', e);
        }
    }

    function browseFolder(inputId) {
        const input = document.getElementById(inputId);
        const startPath = input.value || '/media';

        folderBrowser.open(startPath, (selectedPath) => {
            input.value = selectedPath;
        });
    }

    async function stopCleanup() {
        if (!confirm('Are you sure you want to stop the cleanup operation? It will finish the current file and then stop.')) return;

        try {
            await fetch('/api/cleanup/stop', { method: 'POST' });
            checkStatus();
        } catch (e) {
            alert('Failed to send stop signal: ' + e.message);
        }
    }


    async function loadCleanupActivity() {
        try {
            const response = await fetch('/api/monitoring/activity?limit=40');
            const activities = await response.json();
            const feed = document.getElementById('cleanupActivityFeed');
            const rows = activities.filter(a => a.source === 'cleanup' || a.destination);
            if (!rows.length) {
                feed.innerHTML = '<p style="color:#666;">No cleanup activity yet.</p>';
                return;
            }
            feed.innerHTML = rows.map(a => {
                const time = new Date(a.timestamp).toLocaleString();
                const name = (a.file_path || '').split('/').pop();
                const lang = a.language ? `<div><strong>Language:</strong> ${a.language}</div>` : '';
                const dest = a.destination ? `<div style="word-break:break-all;"><strong>Destination:</strong> ${a.destination}</div>` : '';
                const details = a.reason ? `<div style="color:#666;">${a.reason}</div>` : '';
                return `<div style="border:1px solid #eee; border-left:4px solid #1976d2; border-radius:6px; padding:10px; margin:8px 0;">
                    <div style="font-size:11px; color:#666;">${time}</div>
                    <div><strong>${name || a.file_path}</strong></div>${lang}${dest}${details}
                </div>`;
            }).join('');
        } catch (e) {
            document.getElementById('cleanupActivityFeed').innerHTML = '<p style="color:red;">Failed to load cleanup activity.</p>';
        }
    }

    async function startCleanup() {
        const origin = document.getElementById('origin').value;
        const malayalamDest = document.getElementById('malayalam_dest').value;
        const englishDest = document.getElementById('english_dest').value;
        const dryRun = document.getElementById('dry_run').checked;

        if (!origin || !malayalamDest || !englishDest) {
            alert('Please select all required folders.');
            return;
        }

        const payload = {
            origin_dir: String(origin),
            malayalam_dest: String(malayalamDest),
            english_dest: String(englishDest),
            dry_run: Boolean(dryRun)
        };
        console.log('Starting cleanup with payload:', payload);

        try {
            const response = await fetch('/api/cleanup/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();

            if (data.status === 'error' || data.error) {
                alert('Error: ' + (data.message || data.error));
            } else {
                checkStatus();
            }
        } catch (e) {
            alert('Failed to start cleanup: ' + e.message);
        } finally {
            startBtn.disabled = false;
            startBtn.style.opacity = '1';
        }
    }
</script>
{% endblock %}