{% extends "base.html" %}

{% block title %}Settings{% endblock %}
{% block header %}System Settings{% endblock %}

{% block content %}
<div class="card">
    <form action="/api/settings/save" method="POST">
        <h3>üîë API Configuration</h3>
        <label for="TMDB_API_KEY">TMDB API Key:</label><br>
        <div class="input-group">
            <input type="text" id="TMDB_API_KEY" name="TMDB_API_KEY" value="{{ config.TMDB_API_KEY }}"
                style="flex: 1; padding: 8px;">
            <button type="button" class="btn btn-secondary" onclick="testTMDB()">Test Connection</button>
        </div>
        <div id="tmdbStatus" style="margin-top: 5px; font-size: 14px; display: none;"></div>
        <p style="color: #666; font-size: 13px; margin-top: 5px;">Required for automatic metadata and poster fetching.
        </p>

        <h3>üìÅ Directory Configuration</h3>
        <p style="color: #666; font-size: 14px;">Define where Filearr watches for new movies and where it moves them.
        </p>

        <label for="INPUT_DIR">Watch Folder (Input Directory):</label>
        <div class="input-group">
            <input type="text" id="INPUT_DIR" name="INPUT_DIR" value="{{ config.INPUT_DIR }}">
            <button type="button" class="btn btn-secondary" onclick="browseFolder('INPUT_DIR')">Browse...</button>
        </div>

        <label for="OUTPUT_DIR">Primary Output Root:</label>
        <div class="input-group">
            <input type="text" id="OUTPUT_DIR" name="OUTPUT_DIR" value="{{ config.OUTPUT_DIR }}">
            <button type="button" class="btn btn-secondary" onclick="browseFolder('OUTPUT_DIR')">Browse...</button>
        </div>

        <h4 style="margin-top: 25px;">Advanced Path Overrides</h4>

        <label for="MOVIES_DIR">English Movies Destination:</label>
        <div class="input-group">
            <input type="text" id="MOVIES_DIR" name="MOVIES_DIR" value="{{ config.MOVIES_DIR }}">
            <button type="button" class="btn btn-secondary" onclick="browseFolder('MOVIES_DIR')">Browse...</button>
        </div>

        <label for="MALAYALAM_DIR">Malayalam Movies Destination:</label>
        <div class="input-group">
            <input type="text" id="MALAYALAM_DIR" name="MALAYALAM_DIR" value="{{ config.MALAYALAM_DIR }}">
            <button type="button" class="btn btn-secondary" onclick="browseFolder('MALAYALAM_DIR')">Browse...</button>
        </div>

        <label for="REJECTED_DIR">Rejected Files Folder:</label>
        <div class="input-group">
            <input type="text" id="REJECTED_DIR" name="REJECTED_DIR" value="{{ config.REJECTED_DIR }}">
            <button type="button" class="btn btn-secondary" onclick="browseFolder('REJECTED_DIR')">Browse...</button>
        </div>

        <div style="margin-top: 30px;">
            <button type="submit" class="btn btn-primary">Save Settings</button>
        </div>
    </form>
</div>


<div class="card">
    <h3>üõ°Ô∏è Automation Safety & History</h3>
    <ul style="color:#444; line-height:1.7;">
        <li>Sample files and tiny files are skipped before TMDB lookup.</li>
        <li>Strict year-lock + confidence checks are active to avoid wrong matches.</li>
        <li>Dashboard now supports <strong>Reverse</strong> for processed history entries.</li>
        <li>Live activity includes detected language and destination path.</li>
    </ul>
    <div id="settingsActivityPreview" style="max-height:220px; overflow-y:auto; font-size:13px; border:1px solid #eee; border-radius:6px; padding:10px;">
        <p style="color:#666;">Loading latest activity...</p>
    </div>
</div>

<!-- Ignore Patterns Section -->
<div class="card">
    <h3>üö´ Ignore Patterns</h3>
    <p style="color: #666;">Define glob patterns for files that should be ignored (e.g., <code>*.sample</code>,
        <code>*trailer*</code>).
    </p>

    <div id="patternsList" style="margin: 15px 0;">
        <p>Loading patterns...</p>
    </div>

    <div class="input-group">
        <input type="text" id="newPattern" placeholder="e.g. *.txt or *dummy*">
        <button type="button" class="btn" onclick="addPattern()">Add Pattern</button>
    </div>
</div>

<!-- Ignored Files Section -->
<div class="card">
    <h3>üìã Ignored Files</h3>
    <p style="color: #666;">Specific files you've manually ignored from the monitoring dashboard.</p>

    <div id="ignoredFilesList" style="margin: 15px 0;">
        <p>Loading ignored files...</p>
    </div>
</div>

<style>
    .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    .input-group input {
        flex: 1;
        padding: 8px;
    }
</style>

{% endblock %}

{% block scripts %}
<script src="/static/folder-browser.js"></script>
<script>
    // Folder Browsing Integration
    function browseFolder(inputId) {
        const input = document.getElementById(inputId);
        const startPath = input.value || '/media';

        folderBrowser.open(startPath, (selectedPath) => {
            input.value = selectedPath;
        });
    }

    // TMDB Verification
    async function testTMDB() {
        const key = document.getElementById('TMDB_API_KEY').value.trim();
        const statusDiv = document.getElementById('tmdbStatus');

        if (!key) {
            statusDiv.style.display = 'block';
            statusDiv.style.color = '#dc3545';
            statusDiv.innerText = '‚ùå Please enter an API key';
            return;
        }

        statusDiv.style.display = 'block';
        statusDiv.style.color = '#007bff';
        statusDiv.innerText = '‚è≥ Testing connection...';

        try {
            const response = await fetch(`/api/settings/test-tmdb?api_key=${encodeURIComponent(key)}`);
            const data = await response.json();

            if (data.success) {
                statusDiv.style.color = '#28a745';
                statusDiv.innerText = '‚úÖ ' + data.message;
            } else {
                statusDiv.style.color = '#dc3545';
                statusDiv.innerText = '‚ùå ' + data.message;
            }
        } catch (e) {
            statusDiv.style.color = '#dc3545';
            statusDiv.innerText = '‚ùå Error connecting to backend';
        }
    }


    async function loadSettingsActivityPreview() {
        try {
            const res = await fetch('/api/monitoring/activity?limit=10');
            const rows = await res.json();
            const el = document.getElementById('settingsActivityPreview');
            if (!rows.length) {
                el.innerHTML = '<p style="color:#666;">No activity yet.</p>';
                return;
            }
            el.innerHTML = rows.map(r => {
                const t = new Date(r.timestamp).toLocaleString();
                const f = (r.file_path || '').split('/').pop();
                const lang = r.language ? ` ‚Ä¢ lang: ${r.language}` : '';
                const dst = r.destination ? `<div style="word-break:break-all; color:#555;">‚Üí ${r.destination}</div>` : '';
                return `<div style="padding:6px 0; border-bottom:1px solid #f1f1f1;">
                    <div><strong>${f || r.file_path}</strong> <span style="color:#666;">(${r.action}${lang})</span></div>
                    <div style="font-size:11px; color:#888;">${t}</div>${dst}
                </div>`;
            }).join('');
        } catch (e) {
            document.getElementById('settingsActivityPreview').innerHTML = '<p style="color:red;">Failed to load activity preview.</p>';
        }
    }

    // Patterns Management
    async function loadPatterns() {
        try {
            const response = await fetch('/api/ignore/patterns');
            const patterns = await response.json();

            const list = document.getElementById('patternsList');
            if (patterns.length === 0) {
                list.innerHTML = '<p style="color: #666;">No patterns defined.</p>';
                return;
            }

            let html = '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
            patterns.forEach(p => {
                html += `
                    <div style="background: #e9ecef; padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                        <code>${p}</code>
                        <span style="cursor: pointer; color: #dc3545; font-weight: bold;" onclick="removePattern('${p}')">&times;</span>
                    </div>
                `;
            });
            html += '</div>';
            list.innerHTML = html;
        } catch (e) {
            console.error('Error loading patterns:', e);
        }
    }

    async function addPattern() {
        const input = document.getElementById('newPattern');
        const pattern = input.value.trim();
        if (!pattern) return;

        try {
            const response = await fetch(`/api/ignore/add?pattern=${encodeURIComponent(pattern)}`, { method: 'POST' });
            if (response.ok) {
                input.value = '';
                loadPatterns();
            } else {
                alert('Failed to add pattern');
            }
        } catch (e) {
            alert('Error adding pattern: ' + e.message);
        }
    }

    async function removePattern(pattern) {
        if (!confirm(`Remove pattern: ${pattern}?`)) return;

        try {
            const response = await fetch(`/api/ignore/remove?pattern=${encodeURIComponent(pattern)}`, { method: 'DELETE' });
            if (response.ok) {
                loadPatterns();
            } else {
                alert('Failed to remove pattern');
            }
        } catch (e) {
            alert('Error removing pattern: ' + e.message);
        }
    }

    // Ignored Files Management
    async function loadIgnoredFiles() {
        try {
            const response = await fetch('/api/ignore/files');
            const data = await response.json();

            const list = document.getElementById('ignoredFilesList');
            if (data.files.length === 0) {
                list.innerHTML = '<p style="color: #666;">No files manually ignored.</p>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            data.files.forEach(file => {
                const ignoredDate = new Date(file.ignored_at).toLocaleString();
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px;">
                        <div style="flex: 1;">
                            <code>${file.filename}</code><br>
                            <small style="color: #666;">${file.reason || 'No reason'} ‚Ä¢ ${ignoredDate}</small>
                        </div>
                        <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="unignoreFile('${file.file_path}')">Unignore</button>
                    </div>
                `;
            });
            html += '</div>';
            list.innerHTML = html;
        } catch (e) {
            console.error('Error loading ignored files:', e);
        }
    }

    async function unignoreFile(filePath) {
        if (!confirm(`Remove this file from ignore list?`)) return;

        try {
            const response = await fetch(`/api/ignore/file/remove?file_path=${encodeURIComponent(filePath)}`, { method: 'DELETE' });
            if (response.ok) {
                loadIgnoredFiles();
            } else {
                alert('Failed to remove file');
            }
        } catch (e) {
            alert('Error: ' + e.message);
        }
    }

    // Initial load
    loadPatterns();
    loadIgnoredFiles();
    loadSettingsActivityPreview();
</script>
{% endblock %}