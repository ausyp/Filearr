{% extends "base.html" %}

{% block title %}Settings{% endblock %}
{% block header %}System Settings{% endblock %}

{% block content %}
<div class="card">
    <h3>Configuration</h3>
    <form action="/api/settings/save" method="POST">
        <label for="TMDB_API_KEY">TMDB API Key:</label><br>
        <input type="text" id="TMDB_API_KEY" name="TMDB_API_KEY" value="{{ config.get('TMDB_API_KEY') or '' }}"
            style="width: 100%; padding: 8px; margin-bottom: 10px;"><br>

        <label for="INPUT_DIR">Input Directory (Host Path mapped to container):</label>
        <div class="input-group">
            <input type="text" id="INPUT_DIR" name="INPUT_DIR" value="{{ config.get('INPUT_DIR') or '/input' }}">
            <button type="button" class="btn" onclick="openBrowser('INPUT_DIR')">Browse</button>
        </div>
        <small>Note: If you change this, ensure the Docker volume is mounted correctly. Restart required for Watcher
            changes.</small><br><br>

        <label for="OUTPUT_DIR">Output Directory:</label>
        <div class="input-group">
            <input type="text" id="OUTPUT_DIR" name="OUTPUT_DIR" value="{{ config.get('OUTPUT_DIR') or '/output' }}">
            <button type="button" class="btn" onclick="openBrowser('OUTPUT_DIR')">Browse</button>
        </div><br>

        <h4>Advanced Path Overrides (Optional)</h4>

        <label for="MOVIES_DIR">Movies Directory:</label>
        <div class="input-group">
            <input type="text" id="MOVIES_DIR" name="MOVIES_DIR" value="{{ config.get('MOVIES_DIR') or '' }}"
                placeholder="Default: /output/movies">
            <button type="button" class="btn" onclick="openBrowser('MOVIES_DIR')">Browse</button>
        </div><br>

        <label for="MALAYALAM_DIR">Malayalam Movies Directory:</label>
        <div class="input-group">
            <input type="text" id="MALAYALAM_DIR" name="MALAYALAM_DIR" value="{{ config.get('MALAYALAM_DIR') or '' }}"
                placeholder="Default: /output/malayalam-movies">
            <button type="button" class="btn" onclick="openBrowser('MALAYALAM_DIR')">Browse</button>
        </div><br>

        <label for="REJECTED_DIR">Rejected Directory:</label>
        <div class="input-group">
            <input type="text" id="REJECTED_DIR" name="REJECTED_DIR" value="{{ config.get('REJECTED_DIR') or '' }}"
                placeholder="Default: /output/.rejected">
            <button type="button" class="btn" onclick="openBrowser('REJECTED_DIR')">Browse</button>
        </div><br>

        <label for="TRASH_DIR">Trash Directory:</label>
        <div class="input-group">
            <input type="text" id="TRASH_DIR" name="TRASH_DIR" value="{{ config.get('TRASH_DIR') or '' }}"
                placeholder="Default: /output/.trash">
            <button type="button" class="btn" onclick="openBrowser('TRASH_DIR')">Browse</button>
        </div><br>

        <button type="submit" class="btn btn-primary">Save Settings</button>
    </form>

    {% if request.query_params.get('saved') %}
    <div style="margin-top: 20px; color: green; font-weight: bold;">
        Settings saved successfully! You may need to restart the container for some changes to take effect.
    </div>
    {% endif %}
</div>

<!-- Directory Browser Modal -->
<div id="browserModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeBrowser()">&times;</span>
        <h3>Select Directory</h3>
        <div id="currentPath" style="margin-bottom: 10px; font-weight: bold;"></div>
        <div id="fileList" class="file-list"></div>
        <div style="margin-top: 15px; text-align: right;">
            <button type="button" class="btn" onclick="selectCurrentPath()">Select This Folder</button>
            <button type="button" class="btn btn-secondary" onclick="closeBrowser()">Cancel</button>
        </div>
    </div>
</div>

<style>
    .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .input-group input {
        flex-grow: 1;
        padding: 8px;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: #2c2c2c;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
        color: white;
        border-radius: 8px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover {
        color: white;
    }

    .file-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #444;
        padding: 10px;
        background: #1e1e1e;
    }

    .file-item {
        padding: 5px;
        cursor: pointer;
        border-bottom: 1px solid #333;
        display: flex;
        align-items: center;
    }

    .file-item:hover {
        background-color: #444;
    }

    .file-item.folder::before {
        content: "üìÅ";
        margin-right: 8px;
    }

    .file-item.file::before {
        content: "üìÑ";
        margin-right: 8px;
    }

    .file-item.parent::before {
        content: "‚¨ÜÔ∏è";
        margin-right: 8px;
    }
</style>

<script>
    let currentTargetInput = null;
    let currentPath = "/";

    function openBrowser(inputId) {
        currentTargetInput = document.getElementById(inputId);
        let initialPath = currentTargetInput.value || "/";
        // Simple heuristic to ensure path starts with slash on linux
        if (!initialPath.startsWith("/") && !initialPath.match(/^[a-zA-Z]:/)) initialPath = "/";

        document.getElementById('browserModal').style.display = 'block';
        loadDirectory(initialPath);
    }

    function closeBrowser() {
        document.getElementById('browserModal').style.display = 'none';
    }

    async function loadDirectory(path) {
        try {
            const response = await fetch(`/api/filesystem/list?path=${encodeURIComponent(path)}`);
            const data = await response.json();

            if (data.error) {
                // If path invalid (e.g. empty or not found), try root
                if (path !== "/" && path !== "C:\\") {
                    loadDirectory("/");
                    return;
                }
                alert("Error: " + data.error);
                return;
            }

            currentPath = data.current_path;
            document.getElementById('currentPath').innerText = currentPath;
            const list = document.getElementById('fileList');
            list.innerHTML = '';

            // Parent directory
            if (data.parent_path && data.parent_path !== currentPath) {
                const parentDiv = document.createElement('div');
                parentDiv.className = 'file-item parent';
                parentDiv.innerText = '..';
                parentDiv.onclick = () => loadDirectory(data.parent_path);
                list.appendChild(parentDiv);
            }

            // Directories
            data.directories.forEach(dir => {
                const div = document.createElement('div');
                div.className = 'file-item folder';
                div.innerText = dir;

                // Construct path safely for frontend logic (backend does lifting too but good to be clean)
                let nextPath = currentPath.endsWith('/') || currentPath.endsWith('\\') ? currentPath + dir : currentPath + '/' + dir;

                div.onclick = () => loadDirectory(nextPath);
                list.appendChild(div);
            });

        } catch (e) {
            console.error(e);
            alert("Failed to load directory");
        }
    }

    function selectCurrentPath() {
        if (currentTargetInput) {
            currentTargetInput.value = currentPath;
        }
        closeBrowser();
    }

    window.onclick = function (event) {
        const modal = document.getElementById('browserModal');
        if (event.target == modal) {
            closeBrowser();
        }
    }
</script>
{% endblock %}